<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="The intersection of code and photography">

        <meta property="og:title" content="Testing your OpenAPI Contract with Spectator | Matthew Trask"/>
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://matthewtrask.net/blog/contract-testing-with-spectator"/>
        <meta property="og:description" content="The intersection of code and photography" />

        <title>Matthew Trask | Testing your OpenAPI Contract with Spectator</title>

        <link href="//cdn.rawgit.com/noelboss/featherlight/1.7.13/release/featherlight.min.css" type="text/css" rel="stylesheet" />
        <link rel="home" href="https://matthewtrask.net">
        <link rel="icon" href="/favicon.ico">
        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="Matthew Trask Atom Feed">

            <meta property="og:title" content="Testing your OpenAPI Contract with Spectator" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://matthewtrask.net/blog/contract-testing-with-spectator"/>
    <meta property="og:description" content="A nice Laravel test runner that takes your OpenAPI contract and tests it against your actual API." />

                    <script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-64167405-1', 'auto');
              ga('send', 'pageview');

            </script>
        
        <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,700,700i,800,800i" rel="stylesheet">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=cdf0acba8d9fba91dfa2">
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-grey-lightest text-grey-darkest leading-normal font-sans">
        <header class="flex items-center shadow bg-white border-b h-24 py-4" role="banner">
            <div class="container flex items-center max-w-4xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="Matthew Trask home" class="inline-flex items-center">
                        <img class="h-16 md:h-16 mr-3 rounded-full shadow-md" src="/assets/img/matthew-trask.png" alt="Matthew Trask logo" />

                        <h1 class="text-lg md:text-2xl text-teal-darker font-semibold hover:text-teal-dark my-0">Matthew Trask
                            <span class="block text-sm text-grey-darker font-semibold my-0">The intersection of code and photography</span>
                        </h1>
                    </a>
                </div>

                <div id="vue-search" class="flex flex-1 justify-end items-center">
                    <search></search>

                    <nav class="hidden lg:flex items-center justify-end text-lg">
    <a title="Matthew Trask Blog" href="/blog"
        class="ml-6 text-grey-darker hover:text-teal-dark ">
        Blog
    </a>

    <a title="Matthew Trask About" href="/about"
        class="ml-6 text-grey-darker hover:text-teal-dark ">
        About
    </a>
    
    <a title="Matthew Trask About" href="/photography"
        class="ml-6 text-grey-darker hover:text-teal-dark ">
        Photography
    </a>

    <a title="Matthew Trask Contact" href="/contact"
        class="ml-6 text-grey-darker hover:text-teal-dark ">
        Contact
    </a>
</nav>

                    <button class="flex justify-center items-center bg-blue border border-blue h-10 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="nav-menu hidden lg:hidden">
    <ul class="list-reset my-0">
        <li class="pl-4">
            <a
                title="Matthew Trask Blog"
                href="/blog"
                class="nav-menu__item hover:text-blue "
            >Blog</a>
        </li>
        <li class="pl-4">
            <a
                title="Matthew Trask About"
                href="/about"
                class="nav-menu__item hover:text-blue "
            >About</a>
        </li>
        <li class="pl-4">
            <a
                title="Matthew Trask Contact"
                href="/contact"
                class="nav-menu__item hover:text-blue "
            >Contact</a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-xl mx-auto py-16 px-6">
                        <img src="/assets/img/galaxy.jpg" alt="Testing your OpenAPI Contract with Spectator cover image" class="mb-2">
    
    <h1 class="leading-none mb-2">Testing your OpenAPI Contract with Spectator</h1>

    <p class="text-grey-darker text-xl md:mt-0">Matt Trask  â€¢  February 13, 2021</p>
    <p class="text-grey-darker text-sm">Read Time: 7 mins</p>

                        <a
                href="/blog/categories/laravel"
                title="View posts in laravel"
                class="inline-block bg-grey-light hover:bg-teal-lighter leading-loose tracking-wide text-grey-darkest uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >laravel</a>
                    <a
                href="/blog/categories/programming"
                title="View posts in programming"
                class="inline-block bg-grey-light hover:bg-teal-lighter leading-loose tracking-wide text-grey-darkest uppercase text-xs font-semibold rounded mr-4 px-3 pt-px"
            >programming</a>
            
    <div class="border-b border-blue-lighter mb-10 pb-4" v-pre>
        <p>Near the end of last year, a package was released from <a href="https://twitter.com/hotmeteor">Adam Campbell</a> that integrated with the Laravel test runner and allowing for a developer to take the OpenAPI spec file (or contract) and run tests against it. Let's first take a look at the API I built. </p>
<h3>National Parks API</h3>
<p>One thing I have found a love for is the American National Parks system. Various areas in the country preserved for their beauty, the landscapes range from lakes to valleys; mountains and forests; volcanos and deserts. It is my goal to visit every single national park in the United States. When I thought about writing this blog post, I figured building a quick API for the National Parks would be fun, and it was. While it's not deployed yet, the code is viewable <a href="https://github.com/matthewtrask/national-parks-api">here</a>. Right now there are two operations supported: <code>GET /api/national-parks</code> and <code>GET /api/national-parks/{uuid}</code>. As of now, it is just the designated National Parks, but considering the United States has national forests, national military parks, historic places and more, the API will more than likely expand to support those as well as <code>POST, PUT, and DELETE</code> operations.</p>
<p>A sample response (limited to 5 objects for brevity):</p>
<pre><code class="language-json">  "data": [
    {
      "parkUuid": "0b6124e0-53ae-46f2-8a12-d5d6bafd51d0",
      "name": "Acadia",
      "yearEstablished": 1916,
      "state": "Maine",
      "lastUpdated": "2021-02-13T17:20:25.000000Z"
    },
    {
      "parkUuid": "b4670075-c753-4abb-9e01-655bd62deacd",
      "name": "American Somoa",
      "yearEstablished": 1988,
      "state": "American Somoa",
      "lastUpdated": "2021-02-13T17:20:25.000000Z"
    },
    {
      "parkUuid": "428cc8cd-b118-4ff9-9ba2-31892d9be9f5",
      "name": "Arches",
      "yearEstablished": 1929,
      "state": "Utah",
      "lastUpdated": "2021-02-13T17:20:25.000000Z"
    },
    {
      "parkUuid": "7aa48240-06f8-4d8a-a596-aa087afae234",
      "name": "Badlands",
      "yearEstablished": 1939,
      "state": "South Dakota",
      "lastUpdated": "2021-02-13T17:20:25.000000Z"
    },
    {
      "parkUuid": "5a14dcb1-6bb7-4ef1-99be-0a75092200b7",
      "name": "Big Bend",
      "yearEstablished": 1944,
      "state": "Texas",
      "lastUpdated": "2021-02-13T17:20:25.000000Z"
    }
  ],
  "links": {
    "first": "http:\/\/localhost\/api\/national-parks?page=1",
    "last": "http:\/\/localhost\/api\/national-parks?page=13",
    "prev": null,
    "next": "http:\/\/localhost\/api\/national-parks?page=2"
  },
  "meta": {
    "current_page": 1,
    "from": 1,
    "last_page": 13,
    "links": [
      {
        "url": null,
        "label": "&amp;laquo; Previous",
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=1",
        "label": 1,
        "active": true
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=2",
        "label": 2,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=3",
        "label": 3,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=4",
        "label": 4,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=5",
        "label": 5,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=6",
        "label": 6,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=7",
        "label": 7,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=8",
        "label": 8,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=9",
        "label": 9,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=10",
        "label": 10,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=11",
        "label": 11,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=12",
        "label": 12,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=13",
        "label": 13,
        "active": false
      },
      {
        "url": "http:\/\/localhost\/api\/national-parks?page=2",
        "label": "Next &amp;raquo;",
        "active": false
      }
    ],
    "path": "http:\/\/localhost\/api\/national-parks",
    "per_page": "5",
    "to": 5,
    "total": 63
  }
}</code></pre>
<p>Along with this, I have created an OpenAPI Contract as well. While I won't dive deep into OpenAPI this time, the big takeaway to know is that the OpenAPI document is a contract created that you the API developer agree to support. Documenting your responses and abiding by the contract you've laid out is a fantastic way to develop trust with your API consumers.</p>
<p>A sample of the contract:</p>
<img src="/assets/img/openapi-contract.png" alt="image of an openapi contract for the national parks api being demoed in this blog post">
<p>In the contract I am promising a few things: </p>
<ul>
<li>The response data object will always follow the example in the image with an array of objects under a <code>data</code> key, HATEOAS links under a <code>links</code> object, and meta data about pagination under a <code>meta</code> object.</li>
<li>supported query params for the following: state, year, and count. This allows the API to be filtered by state, parks established by a certain year, and or by a specified amount.</li>
</ul>
<h3>Using Spectator</h3>
<p>Up until now, most developers using Laravel are hopefully familiar with testing their APIs. Laravel provides a rich API to test HTTP actions and Spectator ties in very nicely with those. The best part is that Spectator also allows us to clean up our tests by removing some asserts. In order to use Spectator, you need to first run </p>
<pre><code class="language-bash">composer require --dev hotmeteor/spectator &amp;&amp; php artisan vendor:publish --provider="Spectator\SpectatorServiceProvider"</code></pre>
<p>which will publish the config. Looking in your config file for Spectator, you have a few options:</p>
<pre><code class="language-php">return [
    /*
    |--------------------------------------------------------------------------
    | Default Spec Source
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default spec source that should be used
    | by the framework.
    |
    */

    'default' =&gt; env('SPEC_SOURCE', 'local'),

    /*
    |--------------------------------------------------------------------------
    | Sources
    |--------------------------------------------------------------------------
    |
    | Here you may configure as many sources as you wish, and you
    | may even configure multiple source of the same type. Defaults have
    | been setup for each driver as an example of the required options.
    |
    */

    'sources' =&gt; [
        'local' =&gt; [
            'source' =&gt; 'local',
            'base_path' =&gt; env('SPEC_PATH'),
        ],

        'remote' =&gt; [
            'source' =&gt; 'remote',
            'base_path' =&gt; env('SPEC_PATH'),
            'params' =&gt; env('SPUR_URL_PARAMS', ''),
        ],

        'github' =&gt; [
            'source' =&gt; 'github',
            'base_path' =&gt; env('SPEC_PATH'),
            'repo' =&gt; env('SPEC_GITHUB_REPO'),
            'token' =&gt; env('SPEC_GITHUB_TOKEN'),
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Paths
    |--------------------------------------------------------------------------
    |
    | Configure path defaults, like prefixes.
    |
    */

    'path_prefix' =&gt; '',
];</code></pre>
<p>Nothing out of the ordinary, and for this example I am using the <code>local</code> option. At work, we use the <code>remote</code> option with our Github Actions which works really well too.</p>
<p>After all of this has been configured, and it takes minutes or so, we can start developing and testing.</p>
<p>First, lets take a look at a test <em>before</em> we use Spectator. </p>
<pre><code class="language-php">    public function testCanGetParksWithoutSpectator(): void
    {
        $res = $this-&gt;json(
            'GET',
            '/api/national-parks'
        );

        $res-&gt;assertOk()
            -&gt;assertJson([
                'data' =&gt; true,
                'meta' =&gt; true,
                'links' =&gt; true,
            ])
            -&gt;assertHeader('ETag')
            -&gt;assertJsonCount(15, 'data')
            -&gt;assertJsonCount(4, 'links')
            -&gt;assertJsonCount(8, 'meta');
    }</code></pre>
<p>In the example above, we are asserting many things, all of which we promise in our contract. What does this test look like with Spectator though?</p>
<pre><code class="language-php">    use Spectator\Spectator;

    public function testCanGetParks(): void
    {
        Spectator::using('openapi.yml');

        $res = $this-&gt;json(
            'GET',
            '/api/national-parks'
        );

        $res-&gt;assertValidRequest()
            -&gt;assertValidResponse(200);
    }</code></pre>
<p>The API for Spectator is clean, and removes a lot of the assertions I was preforming before hand. Why can I do this? Because the two methods Spectator provides,
<code>assertValidRequest()</code> and <code>assertValidResponse()</code> handle it all for us. Under the hood, Spectator takes the spec file we have told it to use with the <code>Spectator::using('openapi.yml');</code>
accessor and runs a check on both the request and response. Now, for this request I dont have a body or headers I am checking for, but the response has a body I have agreed to with the contract. Had I created a <code>POST</code> action, the request validation assertion would have been incredibly useful to make sure my request body matches what the contract states it should be. You aren't limited to just these two assertions either, you have the full suite of Laravel HTTP JSON assertions and more at the ready. However because I completed the contract with both models of the parks object and meta object, Spectator will use those to compare the response from the API to what I say it should be. </p>
<p>Spectator is another tool in the API developers tool box, and a powerful one at that. It has helped us uncover bugs in our SOA project at work, and freed up time we would normally spend testing so we can move on to working on other problems. You can find the repo <a href="https://github.com/hotmeteor/spectator">here</a> where Adam does a wonderful job managing the issues and pull requests. </p>
<p>If you are looking to start a new API with Laravel adding Spectator, the <a href="/blog/openapi-initializer/">Primitive/OpenAPI-Initializer</a> package to scaffold your contract, and <a href="https://stoplight.io">Stoplight's Studio and Spectral</a> for desiging and linting your contract; to your project will help you develop faster and with more confidence that your API will respond the correct way. </p>
<p>Cheers!</p>    </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://matthewtrask.net/blog/signed-urls-trusted-proxies" title="Older Post: Using Trusted Proxies with Signed URLs in Laravel">
                    &LeftArrow; Using Trusted Proxies with Signed URLs in Laravel
                </a>
                    </div>

        <div>
                    </div>
    </nav>
        </main>

        <footer class="bg-white text-center text-sm mt-12 py-4" role="contentinfo">
            <ul class="flex flex-col md:flex-row justify-center list-reset">
                <li class="md:mr-2">
                    Written by <a href="https://twitter.com/matthewtrask">Matthew Trask</a> 2021.
                </li>

                <li>
                    Built with <a href="http://jigsaw.tighten.co" title="Jigsaw by Tighten">Jigsaw</a>
                    and <a href="https://tailwindcss.com" title="Tailwind CSS, a utility-first CSS framework">Tailwind CSS</a>.
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=7001cdcdf827737e6494"></script>

        <script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
        <script src="//code.jquery.com/jquery-latest.js"></script>
        <script src="//cdn.rawgit.com/noelboss/featherlight/1.7.13/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>
    </body>
</html>
